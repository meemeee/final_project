{% extends "base.html" %}
{% load static %}
{% load i18n %}


{% block tittle %}
Chat | {{ opponent_username }}
{% endblock %}

{% block main %}
<div class="row flex-nowrap">
    <input id="owner_username" type="hidden" value="{{ request.user.username }}">
    <div class="vertical-nav bg-white px-3 py-2" id="sidebar">
        <p class="text-gray font-weight-bold px-3 mb-2">CHATS</p>
        <div class="px-3">
            <div class="chat-head">
                <h4 class="m-0">{{ request.user.username }}</h4>
                <p class="text-success">Online</p>
            </div>
        </div>
        <hr>
        

        <ul class="nav flex-column bg-white mb-0">
            {% for dialog in object_list %}
            <li class="nav-item">
                {% if dialog.owner == request.user %}
                {% with dialog.opponent.username as username and dialog.messages.last as last_mess %}
                <a href="{% url 'dialogs_detail' username %}" id="user-{{ username }}" class="nav-link">
                    {{ username }}
                    <!-- If there are unread messages (as in the last mess is unread) for request.user -->
                    {% if dialog.messages.all|length > 0  %}
                        {% if not last_mess.read and last_mess.sender != request.user and last_mess.sender|stringformat:"s" != "Bookbot" %}
                            <span id="unread-{{ username }}">
                                <i class="fa fa-commenting-o"></i>
                            </span>
                        {% endif %}
                    {% endif %}
                </a>
                {% endwith %}

                {% else %}
                {% with dialog.owner.username as username and dialog.messages.last as last_mess %}
                <a href="{% url 'dialogs_detail' username %}" id="user-{{ username }}" class="nav-link">
                    {{ username }}
                    <!-- If there are unread messages (as in the last mess is unread) for request.user -->
                    {% if dialog.messages.all|length > 0 %}
                        {% if not last_mess.read and last_mess.sender != request.user and last_mess.sender|stringformat:"s" != "Bookbot" %}
                            <span id="unread-{{ username }}">
                                <i class="fa fa-commenting-o"></i>
                            </span>
                        {% endif %}
                    {% endif %}
                </a>
                {% endwith %}
                {% endif %}
            </li>
            {% endfor %}

        </ul>
    </div>


    <!-- <main class="p-2 flex-grow-1 flex-shrink-1 bd-content"> -->
    <main class="page-content p-2" id="content">
        <!-- Toggle button -->
        <button id="sidebarCollapse" type="button" class="btn btn-white rounded-pill p-0 mb-2">
            <i class="text-gray fa fa-chevron-left" style="font-size: 1.4rem;"></i>
        </button>

        <div id="chatbox" class="d-flex flex-column">
            {% if active_dialog %}
            <div class="chat-head">
                <h4 id="channel_title" class="m-0">{{ opponent_username }}</h4>
                <p class="text-success" id="online-status" style="display: none">{% trans "Online" %}</p>
                <p class="text-danger" id="offline-status" style="display: none">{% trans "Offline" %}</p>
            </div>
            <hr>
            <div id="messages" class="chat-body py-3">
                {% for msg in active_dialog.messages.all %}
                <div class="row justify-content-center {% if msg.read %}msg-read{% else %}msg-unread{% endif %}
                    {% if msg.sender != request.user %}opponent{% endif %}" data-id="{{ msg.id }}">
                    <!-- display alert for dialog -->
                    {% if msg.sender|stringformat:"s" == "Bookbot" %}
                    <a href="{{ msg.note }}">
                        <div class="chat-alert text-center">
                            Inquiring about <b>{{ msg.text }}</b>
                        </div>
                    </a>

                    {% else%}
                    <!-- display normal messages -->
                        {% if msg.sender == request.user %}
                        <p class="ml-auto mr-3">
                            <span class="username single-message">
                                <span class="timestamp"
                                data-livestamp="{{ msg.get_formatted_create_datetime }}">
                                    {{ msg.get_formatted_create_datetime }}
                                </span>
                                <b>{{ msg.sender.username }}:</b> {{ msg.text }}
                            </span>
                        </p>
                        {% else %}
                        <p class="ml-3 mr-auto">
                            <span class="username single-message">
                                <b>{{ msg.sender.username }}:</b> {{ msg.text }}
                                <span class="timestamp"
                                data-livestamp="{{ msg.get_formatted_create_datetime }}">
                                    {{ msg.get_formatted_create_datetime }}
                                </span>
                            </span>
                        </p>
                        {% endif %}
                    {% endif %}
                </div>

                <!-- Display welcome mess if this is a new channel -->
                {% empty %}
                <p id="welcome">
                    <i>This is the beginning of your conversation with <b>{{ opponent_username }}</b>.</i>
                </p>
                {% endfor %}

                <!-- Display opponent is typing -->
                <div class="col-md-3 col-md-offset-9">
                    <span class="ml-3 mr-auto" hidden id="typing-text">
                        <strong>{{ opponent_username }} {% trans "is typing..." %}</strong>
                    </span>
                </div>
            </div>

            <div id="type_message" class="chat-foot mt-auto mb-3">
                <div class="form-group d-flex">
                    <!-- <textarea id="chat-message" class="form-control message"
                        placeholder="{% trans 'Write a message' %}"></textarea> -->
                    <!-- <div class="py-2">
                        <button id="btn-send-message" class="btn btn-primary float-right send-message" type="submit"
                            value="{% trans 'Send' %}">Send</button>
                    </div> -->
                    <input autocomplete="off" class="form-control rounded-pill shadow-none" 
                        id="chat-message" placeholder="Write a message" type="text">
                    <div class="">
                        <button id="send" class="btn btn-white rounded-pill send-message shadow-none" type="submit">
                            <i class="fa fa-paper-plane" style="font-size: 1.4rem; color: rgb(0, 110, 255);"></i>
                        </button>
                    </div>
                </div>
            </div>

            {% else %}
            <!-- No dialog to display -->
            <div class="col chat-head">
                <h4 id="no_dialog_title">Oopsiee...</h4>
            </div>
            <hr>
            <div id="no_dialog_messages" class="col chat-body py-3">
                <i>
                    <p>No dialogs yet :(</p>
                    <p>Let's <a id="referrer">go back</a> and start messaging book lenders.</p>
                </i>
            </div>
            {% endif %}
        </div>
    </main>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/scrollmonitor/1.2.0/scrollMonitor.js"
    integrity="sha256-BseZlDlA+yL4qu+Voi82iFa5aaifralQEXIjOjaXgeo=" crossorigin="anonymous"></script>
<script>
    // Insert referrer url to 'go back' text if available
    if (document.querySelector("#referrer")) {
        document.querySelector("#referrer").href = document.referrer;
    }

    $(function () {
        // Sidebar toggle behavior
        $('#sidebarCollapse').on('click', function () {
            $('#sidebar, #content').toggleClass('active');
        });
    });

    // Set up websocket
    var base_ws_server_path = "{{ ws_server_path }}";
    $(document).ready(function () {

        var websocket = null;
        var monitor = null;

        function initReadMessageHandler(containerMonitor, elem) {
            var id = $(elem).data('id');
            var elementWatcher = containerMonitor.create(elem);
            elementWatcher.enterViewport(function () {
                var opponent_username = getOpponnentUsername();
                var packet = JSON.stringify({
                    type: 'read_message',
                    session_key: '{{ request.session.session_key }}',
                    username: opponent_username,
                    message_id: id
                });
                $(elem).removeClass('msg-unread').addClass('msg-read');
                websocket.send(packet);

            });
        }

        function initScrollMonitor() {
            var containerElement = $("#messages");
            var containerMonitor = scrollMonitor.createContainer(containerElement);

            // Mark 'Read' when scrolling messages
            document.querySelectorAll('.msg-unread').forEach(div => {
                if (div.classList.contains('opponent')) {
                    initReadMessageHandler(containerMonitor, div);
                };
            });

            return containerMonitor
        }

        function getOpponnentUsername() {
            return "{{ opponent_username }}";
        }

        // TODO: Use for adding new dialog
        function addNewUser(packet) {
            $('#user-list').html('');
            packet.value.forEach(function (userInfo) {
                if (userInfo.username == getUsername()) return;
                var tmpl = Handlebars.compile($('#user-list-item-template').html());
                $('#user-list').append(tmpl(userInfo))
            });
        }

        function addNewMessage(packet) {
            var msg_class = "";
            
            if (packet['sender_name'] == $("#owner_username").val()) {
                msg_class = "ml-auto mr-3";
                var msgElem =
                $('<div class="row msg-unread" data-id="' + packet.message_id + '">' +
                    '<p class="' + msg_class + '">' +
                    '<span class="username single-message">' + 
                    ' <span class="timestamp" data-livestamp="' + packet['created'] + '"> ' + packet['created'] + '</span> ' +
                    '<b>' + packet['sender_name'] + ': </b>' + packet['message'] +
                    '</span></p></div>');
            } else {
                msg_class = "ml-3 mr-auto";
                var msgElem =
                $('<div class="row msg-unread" data-id="' + packet.message_id + '">' +
                    '<p class="' + msg_class + '">' +
                    '<span class="username single-message">' + 
                    '<b>' + packet['sender_name'] + ': </b>' + packet['message'] +
                    ' <span class="timestamp" data-livestamp="' + packet['created'] + '"> ' + packet['created'] + 
                    '</span></span></p></div>');
            }
    
            $('#messages').append(msgElem);
            scrollToLastMessage()
        }

        function scrollToLastMessage() {
            var $msgs = $('#messages');
            $msgs.animate({ "scrollTop": $msgs.prop('scrollHeight') });
        }

        function generateMessage(context) {
            var tmpl = Handlebars.compile($('#chat-message-template').html());
            return tmpl({ msg: context })
        }

        function gone_online() {
            $("#offline-status").hide();
            $("#online-status").show();
        }

        function gone_offline() {
            $("#online-status").hide();
            $("#offline-status").show();
        }

        // flash button and add 'Unread' icon
        function flash_user_button(username) {
            var btn = $("#user-" + username);
            btn.fadeTo(700, 0.1, function () {
                $(this).fadeTo(800, 1.0);
            });

            // Discard action if there has been an earlier alert
            if (btn[0].classList.contains('convo-unread'))
                return false;
            else {
                const newmess_alert = document.createElement('i');
                newmess_alert.setAttribute('class', 'fa fa-commenting-o');
                btn[0].classList.add('convo-unread');
                btn[0].append(" ");
                btn[0].append(newmess_alert);
            }
        }

        function setupChatWebSocket() {
            var opponent_username = getOpponnentUsername();
            websocket = new WebSocket(base_ws_server_path + '{{ request.session.session_key }}/' + opponent_username);

            websocket.onopen = function (event) {
                var opponent_username = getOpponnentUsername();
                console.log(opponent_username);
                var onOnlineCheckPacket = JSON.stringify({
                    type: "check-online",
                    session_key: '{{ request.session.session_key }}',
                    username: opponent_username
                    // Sending username because the user needs to know if his opponent is online
                });
                var onConnectPacket = JSON.stringify({
                    type: "online",
                    session_key: '{{ request.session.session_key }}'

                });

                console.log('connected, sending:', onConnectPacket);
                websocket.send(onConnectPacket);
                console.log('checking online opponents with:', onOnlineCheckPacket);
                websocket.send(onOnlineCheckPacket);
                monitor = initScrollMonitor();
            };


            window.onbeforeunload = function () {


                var onClosePacket = JSON.stringify({
                    type: "offline",
                    session_key: '{{ request.session.session_key }}',
                    username: opponent_username,
                    // Sending username because to let opponnent know that the user went offline
                });
                console.log('unloading, sending:', onClosePacket);
                websocket.send(onClosePacket);
                websocket.close();

            };


            websocket.onmessage = function (event) {
                var packet;

                try {
                    packet = JSON.parse(event.data);
                    console.log(packet)
                } catch (e) {
                    console.log(e);
                }

                switch (packet.type) {
                    case "new-dialog":
                        // TODO: add new dialog to dialog_list
                        break;
                    case "user-not-found":
                        // TODO: dispay some kind of an error that the user is not found
                        break;
                    case "gone-online":
                        if (packet.usernames.indexOf(opponent_username) != -1) {
                            gone_online();
                        } else {
                            gone_offline();
                        }
                        for (var i = 0; i < packet.usernames.length; ++i) {
                            // setUserOnlineOffline(packet.usernames[i], true);
                        }
                        break;
                    case "gone-offline":
                        if (packet.username == opponent_username) {
                            gone_offline();
                        }
                        // setUserOnlineOffline(packet.username, false);
                        break;
                    case "new-message":
                        if (packet['sender_name'] == opponent_username || packet['sender_name'] == $("#owner_username").val()) {
                            addNewMessage(packet);
                            if (packet['sender_name'] == opponent_username) {
                                initReadMessageHandler(monitor, $("div[data-id='" + packet['message_id'] + "']"));
                            }
                            else {
                                // remove 'Unread' icon (if any) when responding with a new mess 
                                if (document.querySelector("#unread-" + opponent_username)) {
                                    document.querySelector("#unread-" + opponent_username).remove();
                                }
                               
                            }
                        } else {
                            flash_user_button(packet['sender_name']);
                        }
                        break;
                    // case "opponent-typing":
                    //     var typing_elem = $('#typing-text');
                    //     if (!typing_elem.is(":visible")) {
                    //         typing_elem.fadeIn(500);
                    //     } else {
                    //         typing_elem.stop(true);
                    //         typing_elem.fadeIn(0);
                    //     }
                    //     typing_elem.fadeOut(3000);
                    //     break;
                    case "opponent-read-message":
                        if (packet['username'] == opponent_username) {
                            $("div[data-id='" + packet['message_id'] + "']").removeClass('msg-unread').addClass('msg-read');
                        }
                        break;

                    default:
                        console.log('error: ', event)
                }
            }
        }

        function sendMessage(message) {
            var opponent_username = getOpponnentUsername();
            var newMessagePacket = JSON.stringify({
                type: 'new-message',
                session_key: '{{ request.session.session_key }}',
                username: opponent_username,
                message: message
            });
            websocket.send(newMessagePacket)
        }

        $('#chat-message').keypress(function (e) {
            if (e.which == 13 && this.value) {
                sendMessage(this.value);
                this.value = "";
                return false
            } else {
                var opponent_username = getOpponnentUsername();
                var packet = JSON.stringify({
                    type: 'is-typing',
                    session_key: '{{ request.session.session_key }}',
                    username: opponent_username,
                    typing: true
                });
                websocket.send(packet);
            }
        });

        $('#btn-send-message').click(function (e) {
            var $chatInput = $('#chat-message');
            var msg = $chatInput.val();
            if (!msg) return;
            sendMessage($chatInput.val());
            $chatInput.val('')
        });

        setupChatWebSocket();
        scrollToLastMessage();
    });

</script>
{% endblock %}