{% extends "base_generic.html" %}

{% block tittle %}
{{ bookinstance.title }}
{% endblock %}

{% block main %}
<div class="container px-0 pb-1">
    <div class="row mb-1">
        <div class="col-md-4">
            <img src= "{{ bookinstance.cover.url }}" 
            class="pb-5" 
            alt="{{ bookinstance.title }}" 
            style="width: 100%; height: 100%;">
        </div>
        <div class="col-md-8 bd-content">
            <h1 class="title">{{ bookinstance.title }}</h1>
            <p class="lead author-info">By {{ bookinstance.author }}</p>
            
            <p class="mt-3">{{ bookinstance.summary }}</p>  
            
            <!-- show Lender/Borrower depending on user -->
            {% if user.get_username == bookinstance.created_by|stringformat:"s" %}
                <p><b>Borrower: </b>{{ bookinstance.borrower }}</p>
            {% else %}
                <p><b>Lender: </b>{{ bookinstance.created_by }}</p>
            {% endif %}

            <p><b>Availability:</b>
                <span
                class="{% if bookinstance.status == 'a' %}text-success{% else %}text-warning{% endif %}">
                {{ bookinstance.get_status_display }}
                </span>
            </p>
            {% if bookinstance.status != 'a' %}
            <p><strong>Due to be returned:</strong> {{ bookinstance.due_back }}</p>
            {% else %}
            <p><strong>Condition: </strong> {{ bookinstance.get_condition_display }}</p>
            <p><strong>Price: </strong> {{ bookinstance.price }}k VND</p>
            {% endif %}
        </div>
    
    </div>
</div>

<div class="my-1">
    <div class=" text-center p-2 bd-highlight">  
        <!-- Lender can edit/remove books and contact borrower -->
        {% if user.get_username == bookinstance.created_by|stringformat:"s" %}
            <a href="{% url 'edit-book' bookinstance.id %}">
                <button class="mr-1 btn btn-primary">
                    Edit status
                </button>
            </a>
            {% if bookinstance.status == 'o' %}
            <a href="{% url 'dialogs_detail' bookinstance.borrower %}">
                <button class="btn btn-primary">
                    Contact Borrower
                </button>
            </a>
            
            <!-- Book owner can only remove books not on loan -->
            {% else%}
            <a href="{% url 'remove-book' bookinstance.id %}">
                <button id="remove" class="btn btn-primary">
                    Remove
                </button>
            </a>
            {% endif %}
        <!-- Borrower & others can contact Lender -->    
        {% else %}
            <a href="/alert/{{ bookinstance.created_by }}">
                <button class="btn btn-primary">
                {% if bookinstance.status == 'o' and user.get_username == bookinstance.borrower|stringformat:"s" %}
                    Contact Lender
                {% elif bookinstance.status == 'a' %}
                    Request to borrow
                {% endif %}
                </button>
            </a>
        {% endif %}
    </div>
</div>


<script>
    // Remove button is clicked on
    if (document.querySelector('#remove')) {
        document.querySelector('#remove').onclick = event => {
            event.preventDefault();
            var result = confirm("Do you want to remove this book?");
            if (result) {
                localStorage.setItem('remove', true);
                localStorage.setItem('title', "{{ bookinstance.title }}");
                window.location.href = "{% url 'remove-book' bookinstance.id %}";
            };
        };
    }
    
</script>

{% endblock %}